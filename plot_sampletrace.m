%%    
datafile = "/Users/lukasfischer/Work/exps/Shiqian/CaMKII/Com-TN/Mouse 1/day 0/T0_rigid.sig"; % File path to the data

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII RITE day 0
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/RITE/Mouse 1/day 0/T0_rigid.sig"; % File path to the data
plot_rois = [3,7,11,32];   
% frame_range = [1100,4400];
frame_range = [600,3900];
plot_title = 'RITE day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII RITE day 7 
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/RITE/Mouse 1/day 7/T7.sig"; % File path to the data
plot_rois = [2,4,7,1];   
frame_range = [900,4200];
plot_title = 'RITE day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII RITE day 14 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/RITE/Mouse 4/day 14/T14.sig"; % File path to the data
plot_rois = [2,4,6,10];   
frame_range = [1300,4600];
plot_title = 'RITE day 14';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII RITE day 21 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/RITE/Mouse 4/day 21/T21.sig"; % File path to the data
plot_rois = [6,8,10,12];   
frame_range = [1,3300];
plot_title = 'RITE day 21';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII RITE day 28 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/RITE/Mouse 4/day 28/T28.sig"; % File path to the data
plot_rois = [1,10,11,15];   
frame_range = [2000,5300];
plot_title = 'RITE day 28';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII IONCC day 0 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/IoN-CCI/Mouse 4/day 0/T0.sig"; % File path to the data
plot_rois = [18,10,15,17];   
frame_range = [1500,4800];
plot_title = 'IONCC day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII IONCC day 3 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/IoN-CCI/Mouse 4/day 3/T3.sig"; % File path to the data
plot_rois = [5,7,10,21];   
frame_range = [1,3300];
plot_title = 'IONCC day 3';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII IONCC day 7 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/IoN-CCI/Mouse 4/day 7/T7.sig"; % File path to the data
plot_rois = [7,18,20,10];   
frame_range = [1,3300];
plot_title = 'IONCC day 7';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII IONCC day 14 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/IoN-CCI/Mouse 4/day 14/T14.sig"; % File path to the data
plot_rois = [2,4,6,10];   
frame_range = [1,3300];
plot_title = 'RITE day 14';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII IONCC day 21 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/IoN-CCI/Mouse 4/day 21/T21.sig"; % File path to the data
plot_rois = [6,8,10,13];   
frame_range = [1,3300];
plot_title = 'RITE day 21';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII IONCC day 28 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/IoN-CCI/Mouse 4/day 28/T28.sig"; % File path to the data
plot_rois = [2,3,12,17];   
frame_range = [1500,4800];
plot_title = 'RITE day 28';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII SHAM day 0 M1
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/SHAM/Sham(Com-TN)/Mouse 1/day 0/T0.sig"; % File path to the data
plot_rois = [2,4,5,9];   
frame_range = [1,3300];
plot_title = 'SHAM day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII SHAM day 7 M1
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/SHAM/Sham(Com-TN)/Mouse 1/day 7/T7.sig"; % File path to the data
plot_rois = [1,4,9,2];   
frame_range = [1,3320];
plot_title = 'SHAM day 7';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% SHAM RITE day 14 M1
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/SHAM/Sham(Com-TN)/Mouse 1/day 14/T14.sig"; % File path to the data
plot_rois = [2,4,6,13];   
frame_range = [1,3300];
plot_title = 'RITE day 14';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% SHAM RITE day 21 M1
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/SHAM/Sham(Com-TN)/Mouse 1/day 21/T21.sig"; % File path to the data
plot_rois = [2,29,4,9];   
frame_range = [1,3300];
plot_title = 'RITE day 21';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Pilocarpine
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Pilocarpine/T2-4/T2-004-1-450.sig"; % File path to the data
plot_rois = [1,2,3,4];   
frame_range = [1,-1];
plot_title = 'Pilocarpine';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)


%% SHAM RITE day 28 M1
datafile = "/Users/lukasfischer/Work/exps/Shiqian/final dataset/CaMKII/SHAM/Sham(Com-TN)/Mouse 1/day 28/T28.sig"; % File path to the data
plot_rois = [1,2,12,13];   
frame_range = [1,3300];
plot_title = 'RITE day 28';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx IONCC day 0 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/IoN-CCI/Mouse 4/day 0/T.sig"; % File path to the data
plot_rois = [1,4,12,27];   
frame_range = [1000,4300];
plot_title = 'RITE day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx IONCC day 3 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/IoN-CCI/Mouse 4/day 3/T.sig"; % File path to the data
plot_rois = [4,5,26,47];   
frame_range = [1000,4300];
plot_title = 'RITE day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx IONCC day 7 M4
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/IoN-CCI/Mouse 4/day 7/T.sig"; % File path to the data
plot_rois = [1,11,25,31];   
frame_range = [1000,4300];
plot_title = 'RITE day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)


%% Dlx RITE day 0
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/RITE/mouse 1/day 0/T8.sig"; % File path to the data
plot_rois = [2,13,24,30];   
frame_range = [1000,4300];
plot_title = 'RITE day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx RITE day 3
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/RITE/mouse 1/day 3/T8.sig"; % File path to the data
plot_rois = [15,17,37,38];   
frame_range = [1000,4300];
plot_title = 'RITE day 3';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx RITE day 7
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/RITE/mouse 1/day 7/T8.sig"; % File path to the data
plot_rois = [3,4,5,6];   
frame_range = [1000,4300];
plot_title = 'RITE day 7';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx ION day 0
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/IoN-CCI/Mouse 1/day 0/T1.sig"; % File path to the data
plot_rois = [11,14,31,35];   
frame_range = [1000,4300];
plot_title = 'ION day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx ION day 3
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/IoN-CCI/Mouse 1/day 3/T1.sig"; % File path to the data
plot_rois = [1,3,13,49];   
frame_range = [1000,4300];
plot_title = 'ION day 3';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx ION day 7
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/IoN-CCI/Mouse 1/day 7/T1.sig"; % File path to the data
plot_rois = [2,8,20,32];   
frame_range = [1000,4300];
plot_title = 'ION day 7';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx SHAM day 0
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/Sham/Mouse 2/day 0/T5.sig"; % File path to the data
plot_rois = [4,8,28,30];   
frame_range = [1000,4300];
plot_title = 'SHAM day 0';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx SHAM day 3
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/Sham/Mouse 2/day 3/T5.sig"; % File path to the data
plot_rois = [8,20,27,28];   
frame_range = [1000,4300];
plot_title = 'SHAM day 3';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% Dlx SHAM day 7
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Dlx data/Sham/Mouse 2/day 7/T5.sig"; % File path to the data
plot_rois = [4,7,24,33];   
frame_range = [1000,4300];
plot_title = 'SHAM day 7';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII CARBAMAZEPINE BASELINE
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Carbamazepine/Mouse 1/Carb 30 mg/Carb before/T_rigid.sig"; % File path to the data
plot_rois = [38,5,17,37];   
frame_range = [1,3300];
plot_title = 'CARB BASELINE';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% CaMKII CARBAMAZEPINE 60 mg
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Carbamazepine/Mouse 1/Carb 60 mg/Carb 30 min/T.sig"; % File path to the data
plot_rois = [28,46,42,37];   
frame_range = [1,3300];
plot_title = 'CARB BASELINE';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% KETEROLAC BEFORE
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Keterolac/Mouse 1/Before/T.sig"; % File path to the data
plot_rois = [46,28,42,37];   
frame_range = [1,3300];
plot_title = 'KETEROLAC BEFORE';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)

%% KETEROLAC AFTER
datafile = "/Users/lukasfischer/Work/exps/Shiqian/Keterolac/Mouse 1/After/T.sig"; % File path to the data
plot_rois = [1,2,3,4];   
frame_range = [1,3300];
plot_title = 'KETEROLAC AFTER';

plot_sampletraces(datafile, plot_rois, frame_range, plot_title)


%%

function plot_sampletraces(datafile, plot_rois, frame_range, plot_title)
    [fPath,fName,fType] = fileparts(datafile);
    full_path = strcat(fPath,filesep,fName,'_analyzed.mat');
    % load analyzed data
    loaded_data = load(full_path, '-mat');
    dff = loaded_data.dff_temp;
    dff_filtered = loaded_data.dff_filtered_temp;
    foopsi_events = loaded_data.foopsi_events;
    foopsi_filtered = loaded_data.foopsi_filtered;

    roi_transients = id_transients_foopsi(dff_filtered,foopsi_events,foopsi_filtered);
    % calculate how many cells are active at any given point in time and separate transients into global and individual
    
    
    figure('Name',plot_title);
    for i=1:length(plot_rois)
        ax = subplot(length(plot_rois),1,i);
        if frame_range(1) == -1
            from_x = 1;
        else
            from_x = frame_range(1);
        end
        if frame_range(2) == -1
            to_x = length(dff_filtered(:,plot_rois(i)));
        else
            to_x = frame_range(2);
        end
        plot(dff_filtered(from_x:to_x,plot_rois(i)), 'Color','k', 'linewidth', 2);
        hold on;
        ylim([-0.5,2.5]);
        box off;
        set(ax,'XColor','none','YColor','none');
        
        [roi_transients_individual, roi_transients_global] = transient_event(dff_filtered,roi_transients,0.5,frame_range(1),frame_range(2),plot_rois(i));
        [fraction_active,event_idx] = calc_fraction_active(dff_filtered, roi_transients, 0.5);
        if size(roi_transients_global) > 0
            transient_idx = roi_transients_global;
            onset_idx = transient_idx(:,1);
            offset_idx = transient_idx(:,2);  
            if size(onset_idx) > 0
                for j=1:size(onset_idx,1)
                    if onset_idx(j) > frame_range(1) && offset_idx(j) < frame_range(2)
                        if size(intersect(onset_idx(j):offset_idx(j),find(event_idx)),1) > 1 
                            onidx = onset_idx(j) - frame_range(1) + 1;
                            offidx = offset_idx(j) - frame_range(1) + 1;
                            plot(onidx-1:offidx,dff_filtered(onset_idx(j)-1:offset_idx(j),plot_rois(i)),'Color','r', 'LineWidth', 2);
                        end
                    end
                end 
            end  
        end
        if size(roi_transients_individual,1) > 0
            onset_idx = roi_transients_individual(:,1);
            offset_idx = roi_transients_individual(:,2);

            if size(onset_idx) > 0
                for j=1:size(onset_idx,1)
                    if onset_idx(j) > frame_range(1) && offset_idx(j) < frame_range(2)
                        onidx = onset_idx(j) - frame_range(1) + 1;
                        offidx = offset_idx(j) - frame_range(1) + 1;
                        plot(onidx-1:offidx,dff_filtered(onset_idx(j)-1:offset_idx(j),plot_rois(i)),'Color','#10D600', 'LineWidth', 2);
                    end
                end
            end
        end
        hold off;
    end
end

function [local_transients, global_transients] = transient_event(dff,roi_transients,event_threshold,start_frame, stop_frame, roi_idx)
    global_transients = [];
    local_transients = [];
    [~,event_idx] = calc_fraction_active(dff, roi_transients, event_threshold);
    transient_idx = roi_transients{roi_idx};
    if ~isempty(transient_idx )
        onset_idx = transient_idx(:,1);
        offset_idx = transient_idx(:,2);  
        if size(onset_idx) > 0
            for j=1:size(onset_idx,1)
                if onset_idx(j) >= start_frame && offset_idx(j) <= stop_frame
                    if size(intersect(onset_idx(j):offset_idx(j),find(event_idx)),1) > 1 
                        global_transients = vertcat(global_transients,[onset_idx(j), offset_idx(j)]);
                    else
                        local_transients = vertcat(local_transients,[onset_idx(j), offset_idx(j)]);
                    end
                end
            end
        end
    end
end

function [fraction_active, evend_idx] = calc_fraction_active(dff, transients, event_threshold)
    rois_active = zeros(size(dff));
    fraction_active = zeros(size(dff,1),1);
    evend_idx = zeros(size(dff,1),1);
    
    for i=1:size(dff,2)
        roi_t = transients{i};
        for j=1:size(roi_t,1)
            rois_active(roi_t(j,1):roi_t(j,2),i) = 1;
        end
    end
    
    for i=1:size(dff,1)
        fraction_active(i) = sum(rois_active(i,:))/size(dff,2);
    end
    
    evend_idx(fraction_active > event_threshold) = 1;
%     disp('test');
end